/*
AKRODLABS Malware Detection YARA Rules
Comprehensive rule set for malware identification
*/

rule APT_Cobalt_Strike_Beacon {
    meta:
        description = "Detects Cobalt Strike beacon in memory"
        author = "AKRODLABS"
        date = "2025-01-01"
        confidence = "High"
        technique = "T1055.001"  // Process Injection: Dynamic-link Library Injection
        
    strings:
        // Beacon initialization code pattern
        $beacon1 = { 48 89 ?? 48 89 ?? 48 ?? ?? ?? ?? ?? ?? E8 }
        
        // Beacon DLL string (often found in memory)
        $beacon2 = "beacon.dll" wide ascii
        
        // User-Agent string commonly used by Cobalt Strike
        $c2_1 = "Mozilla/5.0 (compatible; MSIE" wide ascii
        
        // Reflective DLL loading pattern
        $reflective_loader = { 4C 8B DC 49 89 5B 08 49 89 6B 10 }
        
        // Sleep mask implementation (advanced evasion)
        $sleep_mask = { 48 89 5C 24 ?? 48 89 6C 24 ?? 48 89 74 24 ?? 57 }
        
    condition:
        // Multiple patterns increase confidence
        any of ($beacon*) or ($c2_* and $reflective_loader) or $sleep_mask
}

rule Suspicious_Banking_Trojan {
    meta:
        description = "Banking trojan indicators"
        author = "AKRODLABS"
        date = "2025-01-01"
        
    strings:
        $api1 = "VirtualAlloc" ascii
        $api2 = "WriteProcessMemory" ascii
        $api3 = "CreateRemoteThread" ascii
        $mz = { 4D 5A 90 00 }  // MZ header
        $pe = { 50 45 00 00 }  // PE signature
        
        // Banking-related strings
        $bank1 = "online banking" ascii nocase
        $bank2 = "account balance" ascii nocase
        $bank3 = "login.aspx" ascii nocase
        
    condition:
        ($mz at 0) and $pe and 2 of ($api*) and any of ($bank*)
}

rule Crypto_Miner_Detection {
    meta:
        description = "Cryptocurrency mining malware"
        author = "AKRODLABS"
        date = "2025-01-01"
        
    strings:
        // Mining pools
        $pool1 = "stratum+tcp://" ascii
        $pool2 = "pool.minergate.com" ascii
        $pool3 = "xmr-eu1.nanopool.org" ascii
        
        // Mining software indicators
        $miner1 = "xmrig" ascii nocase
        $miner2 = "cgminer" ascii nocase
        $miner3 = "bfgminer" ascii nocase
        
        // Cryptocurrency wallets
        $wallet = /[13][a-km-zA-HJ-NP-Z1-9]{25,34}/ // Bitcoin address pattern
        
    condition:
        any of ($pool*) or any of ($miner*) or $wallet
}

rule Process_Hollowing_Indicators {
    meta:
        description = "Process hollowing technique indicators"
        author = "AKRODLABS"
        date = "2025-01-01"
        technique = "T1055.012"
        
    strings:
        $api1 = "CreateProcessW" ascii
        $api2 = "NtUnmapViewOfSection" ascii
        $api3 = "WriteProcessMemory" ascii
        $api4 = "SetThreadContext" ascii
        $api5 = "ResumeThread" ascii
        
        // Suspicious CREATE_SUSPENDED flag
        $suspended = { 00 00 00 04 } // CREATE_SUSPENDED = 0x00000004
        
    condition:
        4 of ($api*) and $suspended
}

rule Ransomware_Indicators {
    meta:
        description = "Ransomware behavior indicators"
        author = "AKRODLABS"
        date = "2025-01-01"
        
    strings:
        // File extension patterns
        $ext1 = ".encrypted" ascii
        $ext2 = ".locked" ascii
        $ext3 = ".crypto" ascii
        
        // Ransom note indicators
        $ransom1 = "your files have been encrypted" ascii nocase
        $ransom2 = "bitcoin" ascii nocase
        $ransom3 = "decrypt" ascii nocase
        $ransom4 = "ransom" ascii nocase
        
        // Crypto APIs
        $crypto1 = "CryptEncrypt" ascii
        $crypto2 = "CryptDecrypt" ascii
        $crypto3 = "CryptGenKey" ascii
        
    condition:
        (any of ($ext*) and any of ($ransom*)) or 2 of ($crypto*)
}

rule Android_Banking_Trojan {
    meta:
        description = "Android banking trojan indicators"
        author = "AKRODLABS"
        date = "2025-01-01"
        platform = "Android"
        
    strings:
        // Android permissions
        $perm1 = "android.permission.SEND_SMS" ascii
        $perm2 = "android.permission.RECEIVE_SMS" ascii
        $perm3 = "android.permission.READ_SMS" ascii
        $perm4 = "android.permission.SYSTEM_ALERT_WINDOW" ascii
        
        // Banking app targets
        $target1 = "com.chase.sig.android" ascii
        $target2 = "com.bankofamerica.digitalwallet" ascii
        $target3 = "com.wellsfargo.mobile" ascii
        
        // Overlay attack indicators
        $overlay1 = "TYPE_SYSTEM_OVERLAY" ascii
        $overlay2 = "TYPE_SYSTEM_ALERT" ascii
        
    condition:
        3 of ($perm*) and (any of ($target*) or any of ($overlay*))
}

rule iOS_Spyware_Indicators {
    meta:
        description = "iOS spyware and surveillance tools"
        author = "AKRODLABS"
        date = "2025-01-01"
        platform = "iOS"
        
    strings:
        // Privacy-invasive APIs
        $api1 = "CLLocationManager" ascii
        $api2 = "CNContactStore" ascii
        $api3 = "MFMessageComposeViewController" ascii
        
        // Keychain access
        $keychain1 = "SecItemCopyMatching" ascii
        $keychain2 = "kSecAttrAccessible" ascii
        
        // Stealth indicators
        $stealth1 = "LSUIElement" ascii  // Hidden from Dock
        $stealth2 = "LSBackgroundOnly" ascii
        
    condition:
        2 of ($api*) and any of ($keychain*) and any of ($stealth*)
}
